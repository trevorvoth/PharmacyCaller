# PharmacyCaller MVP Implementation Plan

**Session ID:** plan-2026-01-18-1201
**Created:** 2026-01-18
**Approach:** Twilio + OpenAI Realtime (Full DIY)
**Review Status:** Architectural pivot from Bland AI due to enterprise requirement for warm transfer

---

## 1. Problem Statement

PharmacyCaller eliminates the frustrating experience of calling pharmacies. When patients need to check medication availability, ask about refills, or speak with a pharmacist, they face long hold times (5-15+ minutes) - and if that pharmacy can't help, they start all over with another one.

The solution: The patient enters what they need, and PharmacyCaller:
1. **Finds nearby pharmacies** based on the patient's location
2. **Calls 3 pharmacies simultaneously** using AI agents
3. **Navigates each IVR** and waits on hold in parallel
4. **Queues up connected calls** - as each pharmacist answers, the patient is notified and can join

The patient only spends time talking to pharmacists who are ready - no waiting, no repeating the process if the first pharmacy can't help.

---

## 2. Architecture Overview

```
                    PharmacyCaller Architecture (Twilio + OpenAI DIY)
                    =================================================

   +------------------+     +-------------------+     +----------------+
   |   Patient UI     |     |   PharmacyCaller  |     |   Pharmacies   |
   |   (WebRTC)       |<--->|   Server          |<--->|   (PSTN)       |
   +------------------+     +-------------------+     +----------------+
                                    |
                    +---------------+---------------+
                    |               |               |
              +-----v-----+   +-----v-----+   +-----v-----+
              |  Twilio   |   |  OpenAI   |   | Database  |
              | (Calls +  |   | Realtime  |   | (State)   |
              | Conference)|   | (AI)      |   +-----------+
              +-----------+   +-----------+
```

### Component Responsibilities

| Component | Role |
|-----------|------|
| **Twilio** | Outbound PSTN calls, conference rooms, call bridging, Media Streams |
| **OpenAI Realtime** | Voice AI for IVR navigation, hold monitoring, human detection |
| **WebSocket** | Stream audio between Twilio and OpenAI |
| **Twilio Client SDK** | Patient audio in browser (WebRTC) |
| **Conference** | Bridge AI call + patient into same room |

---

## 3. Scope & Boundaries

### In Scope (MVP)
- **Pharmacy Discovery:** Search for pharmacies near patient's location
- **Parallel Calling:** Initiate up to 3 concurrent AI calls to different pharmacies
- **IVR Navigation:** AI navigates phone menus and waits on hold for each call
- **Call Queue:** Display connected pharmacists (or voicemail prompts) as they become available
- **Voicemail Option:** If pharmacy offers voicemail, queue it for patient to leave a message
- **Patient Join:** Patient joins any queued call via WebRTC (browser/app)
- **Smart Call Management:**
  - Calls on hold continue even after patient joins another call
  - Only end calls where a human has answered but patient chose a different call
  - Play "Thank you for holding" message to waiting pharmacists before ending
- **Pharmacy Tracking Checklist:**
  - Track all pharmacies called in current search
  - After each call, prompt: "Did they have your medication?"
  - Display checklist showing status (calling, on hold, connected, had it, didn't have it)
  - Reset checklist when user indicates medication was found
- **Basic Auth:** Simple user accounts (email/password)
- **Web App:** Browser-based interface (mobile-responsive)
- **Cost Controls:** Per-user search limits, cost alerts
- **Monitoring:** Error tracking, structured logging, basic metrics

### Out of Scope (MVP)
- Insurance verification or billing
- Prescription tracking or medication history
- Multi-language support (English only)
- Enterprise features (multi-tenant, admin dashboards, analytics)
- Native mobile apps (web-first, apps later)
- Pharmacy preference/favorites (v2)
- Call recordings or transcripts (v2)
- Price comparison between pharmacies (v2)
- Safari/Firefox WebRTC support (v2 - Chrome only for MVP)

### Boundaries
- **Geography:** US pharmacies only
- **Concurrent calls per user:** 3 maximum
- **Hold time limit:** 15 minutes per call (auto-cancel if no answer)
- **Supported browsers:** Chrome only (MVP)
- **Per-user limits:** 10 searches/day (MVP)
- **Patient response timeout:** 60 seconds to acknowledge notification

---

## 4. Success Criteria

### Technical Success (MVP Launch)
- [ ] System can initiate 3 parallel AI calls to different pharmacies
- [ ] AI successfully navigates IVR menus for major pharmacy chains (CVS, Walgreens, Rite Aid)
- [ ] AI detects when human pharmacist answers (vs still in IVR/hold)
- [ ] AI detects and queues voicemail prompts
- [ ] Patient receives real-time notification when pharmacist is ready
- [ ] Patient can join call via WebRTC in browser (Chrome)
- [ ] Pharmacy tracking checklist accurately reflects call status
- [ ] System handles 10+ concurrent users without degradation
- [ ] Error tracking captures and reports failures
- [ ] Cost alerts trigger when spending exceeds threshold

### User Experience Success
- [ ] Patient can go from "search" to "talking to pharmacist" in <2 minutes (excluding hold time)
- [ ] IVR navigation success rate >80% for top 10 pharmacy chains
- [ ] WebRTC call quality is clear (no major audio issues)
- [ ] Checklist UI clearly shows which pharmacies have been tried
- [ ] Clear fallback messaging when IVR navigation fails

### Business Success (First 30 Days)
- [ ] Complete 100+ real pharmacy calls
- [ ] At least 1 unique user successfully finds medication
- [ ] Gather user feedback on experience
- [ ] Identify top 3 IVR navigation failures for improvement

---

## 5. Tasks

<!-- EXECUTION_TASKS_START -->

### Batch 0: Spike - Verify Twilio + OpenAI Realtime Capabilities (CRITICAL)

| # | Task | Files | Deps | Batch |
|---|------|-------|------|-------|
| 0.1 | Set up Twilio account, get SID/token, provision phone number | - | - | 0 |
| 0.2 | Set up OpenAI account, get API key with Realtime API access | - | - | 0 |
| 0.3 | Run test-twilio-call.ts to verify outbound calling | `spike/test-twilio-call.ts` | 0.1 | 0 |
| 0.4 | Run test-openai-realtime.ts to verify voice AI connection | `spike/test-openai-realtime.ts` | 0.2 | 0 |
| 0.5 | **CRITICAL:** Run test-conference.ts to verify call bridging | `spike/test-conference.ts` | 0.3 | 0 |
| 0.6 | Document findings and confirm architecture viability | `spike/FINDINGS.md` | 0.5 | 0 |
| 0.V | **GATE:** All 3 tests pass. If bridging fails, investigate Twilio config. | - | 0.6 | 0 |

**NOTE:** Do NOT proceed to Batch 1 until 0.V passes. All spike tests must succeed.

---

### Batch 1: Project Foundation + Observability

| # | Task | Files | Deps | Batch |
|---|------|-------|------|-------|
| 1.1 | Initialize Node.js project with TypeScript and ESLint | `package.json`, `tsconfig.json`, `.eslintrc.js` | 0.V | 1 |
| 1.2 | Configure Fastify server with CORS and env config | `src/server.ts`, `src/config/env.ts`, `.env.example` | 1.1 | 1 |
| 1.3 | Set up Prisma ORM and PostgreSQL connection | `prisma/schema.prisma`, `src/db/client.ts` | 1.1 | 1 |
| 1.4 | Create User model (id, email, password, createdAt, dailySearchCount) | `prisma/schema.prisma` | 1.3 | 1 |
| 1.5 | Create Call model (id, userId, pharmacyId, status, twilioCallSid, conferenceSid, cost, createdAt) | `prisma/schema.prisma` | 1.4 | 1 |
| 1.6 | Create PharmacySearch model (id, userId, medicationQuery, status, createdAt) | `prisma/schema.prisma` | 1.5 | 1 |
| 1.7 | Create PharmacyResult model (id, searchId, pharmacyName, address, phone, callStatus, hasMedication) | `prisma/schema.prisma` | 1.6 | 1 |
| 1.8 | Set up Redis client with connection pooling | `src/services/redis.ts`, `docker-compose.yml` | 1.1 | 1 |
| 1.9 | Create docker-compose with PostgreSQL and Redis | `docker-compose.yml` | 1.3, 1.8 | 1 |
| 1.10 | **Set up Sentry for error tracking** | `src/utils/sentry.ts`, `src/server.ts` | 1.1 | 1 |
| 1.11 | **Set up structured logging (pino)** | `src/utils/logger.ts` | 1.1 | 1 |
| 1.12 | **Create basic metrics collector (call counts, success rates)** | `src/services/metrics.ts` | 1.8 | 1 |
| 1.V | **VERIFY:** Server starts, DB connects, Redis connects, Sentry reports test error | `tests/setup/batch1.test.ts` | 1.12 | 1 |

---

### Batch 2: Authentication & Security

| # | Task | Files | Deps | Batch |
|---|------|-------|------|-------|
| 2.1 | Create password hashing utilities (bcrypt) | `src/utils/password.ts` | 1.V | 2 |
| 2.2 | Create JWT token generation and validation | `src/utils/jwt.ts` | 1.V | 2 |
| 2.3 | Implement user signup endpoint (POST /auth/signup) | `src/routes/auth.ts`, `src/services/userService.ts` | 1.4, 2.1, 2.2 | 2 |
| 2.4 | Implement user login endpoint (POST /auth/login) | `src/routes/auth.ts` | 2.3 | 2 |
| 2.5 | Create auth middleware for protected routes | `src/middleware/auth.ts` | 2.2 | 2 |
| 2.6 | **Add rate limiting middleware (10 req/min per IP)** | `src/middleware/rateLimit.ts` | 1.8 | 2 |
| 2.7 | **Add per-user search limit (10 searches/day)** | `src/middleware/userLimits.ts` | 1.4 | 2 |
| 2.8 | Set up Google Places API client | `src/services/googlePlaces.ts`, `src/config/google.ts` | 1.V | 2 |
| 2.9 | Create pharmacy search function (by location + type=pharmacy) | `src/services/pharmacySearch.ts` | 2.8 | 2 |
| 2.10 | Implement search pharmacies endpoint (GET /pharmacies/search) | `src/routes/pharmacies.ts` | 2.5, 2.9 | 2 |
| 2.V | **VERIFY:** Can signup, login, rate limiting works, search limit enforced | `tests/integration/batch2.test.ts` | 2.10 | 2 |

---

### Batch 3: Twilio + OpenAI Realtime Integration + Cost Tracking

| # | Task | Files | Deps | Batch |
|---|------|-------|------|-------|
| 3.1 | Create Twilio client wrapper | `src/services/twilio/client.ts`, `src/config/twilio.ts` | 2.V | 3 |
| 3.2 | Create OpenAI Realtime WebSocket manager | `src/services/openai/realtimeClient.ts`, `src/config/openai.ts` | 2.V | 3 |
| 3.3 | Define IVR navigation prompt template for pharmacies | `src/services/openai/prompts.ts` | 3.2 | 3 |
| 3.4 | Implement Twilio outbound call function | `src/services/twilio/calls.ts` | 3.1 | 3 |
| 3.5 | Implement Twilio Media Streams handler (audio streaming) | `src/services/twilio/mediaStreams.ts` | 3.4 | 3 |
| 3.6 | Create audio bridge: Twilio Media Streams <-> OpenAI Realtime | `src/services/audioBridge.ts` | 3.2, 3.5 | 3 |
| 3.7 | Implement conference room creation and management | `src/services/twilio/conference.ts` | 3.1 | 3 |
| 3.8 | Create patient join function (add to conference) | `src/services/twilio/conference.ts` | 3.7 | 3 |
| 3.9 | **Add cost tracking per call (Twilio + OpenAI minutes)** | `src/services/costTracker.ts` | 3.4 | 3 |
| 3.10 | **Set up cost alerts (Slack/email when daily spend > $X)** | `src/services/costAlerts.ts` | 3.9 | 3 |
| 3.11 | Define IVR patterns for CVS | `src/config/ivrPatterns/cvs.ts` | 3.3 | 3 |
| 3.12 | Define IVR patterns for Walgreens | `src/config/ivrPatterns/walgreens.ts` | 3.3 | 3 |
| 3.13 | Define IVR patterns for Rite Aid | `src/config/ivrPatterns/riteaid.ts` | 3.3 | 3 |
| 3.14 | Create IVR pattern router (detect chain from phone/name) | `src/services/openai/ivrRouter.ts` | 3.11, 3.12, 3.13 | 3 |
| 3.15 | **Add IVR fallback handler (notify user if navigation fails after 3 attempts)** | `src/services/openai/ivrFallback.ts` | 3.14 | 3 |
| 3.V | **VERIFY:** Can initiate test call with AI, audio streams work, cost tracked | `tests/integration/batch3.test.ts` | 3.15 | 3 |

---

### Batch 4: Call State Machine & Orchestration

| # | Task | Files | Deps | Batch |
|---|------|-------|------|-------|
| 4.1 | Define call states enum (CREATED, DIALING, IVR, IVR_FAILED, HOLD, HUMAN_DETECTED, VOICEMAIL, BRIDGING, CONNECTED, ENDING, ENDED) | `src/types/callStates.ts` | 3.V | 4 |
| 4.2 | Implement Redis-based call state machine | `src/services/callStateMachine.ts` | 1.8, 4.1 | 4 |
| 4.3 | Create state transition validation logic | `src/services/callStateMachine.ts` | 4.2 | 4 |
| 4.4 | Implement parallel call orchestrator (initiate 3 calls) | `src/services/callOrchestrator.ts` | 3.4, 4.2 | 4 |
| 4.5 | Add call progress tracking per pharmacy search | `src/services/callOrchestrator.ts` | 4.4, 1.6 | 4 |
| 4.6 | Implement call queue (track which calls have humans ready) | `src/services/callQueue.ts` | 4.2 | 4 |
| 4.7 | **Play "Thank you for holding" TTS before ending connected calls** | `src/services/callQueue.ts` | 4.6 | 4 |
| 4.8 | Create logic to end connected calls when patient joins another | `src/services/callQueue.ts` | 4.7 | 4 |
| 4.9 | Keep calls on hold running when patient joins one call | `src/services/callQueue.ts` | 4.8 | 4 |
| 4.10 | **Add 60-second patient response timeout (cancel calls if no acknowledgment)** | `src/services/patientTimeout.ts` | 4.6 | 4 |
| 4.V | **VERIFY:** State machine transitions work, timeout cancels calls, polite ending message works | `tests/unit/batch4.test.ts` | 4.10 | 4 |

---

### Batch 5: Webhooks & Real-time Notifications (Secure)

| # | Task | Files | Deps | Batch |
|---|------|-------|------|-------|
| 5.1 | Create Twilio voice webhook endpoint (POST /webhooks/twilio/voice) | `src/routes/webhooks/twilio.ts` | 4.V | 5 |
| 5.2 | Create Twilio status callback endpoint (POST /webhooks/twilio/status) | `src/routes/webhooks/twilio.ts` | 5.1 | 5 |
| 5.3 | **Add Twilio webhook signature verification** | `src/middleware/webhookAuth.ts` | 5.1 | 5 |
| 5.4 | Handle call status events (initiated, ringing, in-progress, completed, failed) | `src/routes/webhooks/twilio.ts` | 5.3, 4.2 | 5 |
| 5.5 | Create OpenAI Realtime event handler (human_detected, voicemail, ivr_failed) | `src/services/openai/eventHandler.ts` | 3.2 | 5 |
| 5.6 | **Handle "human_detected" event from OpenAI AI** | `src/services/openai/eventHandler.ts` | 5.5, 4.2 | 5 |
| 5.7 | **Handle "voicemail_detected" event** | `src/services/openai/eventHandler.ts` | 5.5, 4.2 | 5 |
| 5.8 | **Handle "ivr_failed" event (trigger fallback)** | `src/services/openai/eventHandler.ts` | 5.5, 3.15 | 5 |
| 5.9 | Set up Socket.io WebSocket server | `src/websocket/server.ts` | 1.2 | 5 |
| 5.10 | Create authenticated WebSocket connections | `src/websocket/auth.ts` | 5.9, 2.5 | 5 |
| 5.11 | Implement "pharmacist_ready" notification event | `src/services/notifications.ts` | 5.9 | 5 |
| 5.12 | Implement "voicemail_ready" notification event | `src/services/notifications.ts` | 5.11 | 5 |
| 5.13 | Implement "call_status_update" notification event | `src/services/notifications.ts` | 5.11 | 5 |
| 5.14 | **Implement "ivr_failed" notification event (user sees failure)** | `src/services/notifications.ts` | 5.11 | 5 |
| 5.15 | Connect event handlers to WebSocket notifications | `src/routes/webhooks/twilio.ts`, `src/services/openai/eventHandler.ts` | 5.6, 5.11 | 5 |
| 5.V | **VERIFY:** Webhook auth rejects unsigned, notifications work, IVR failure shows to user | `tests/integration/batch5.test.ts` | 5.15 | 5 |

---

### Batch 6: Pharmacy Tracking & API Routes

| # | Task | Files | Deps | Batch |
|---|------|-------|------|-------|
| 6.1 | Create pharmacy tracker service | `src/services/pharmacyTracker.ts` | 5.V | 6 |
| 6.2 | Implement "start search" endpoint (POST /searches) | `src/routes/searches.ts` | 2.5, 2.9, 4.4 | 6 |
| 6.3 | Implement "get search status" endpoint (GET /searches/:id) | `src/routes/searches.ts` | 6.1 | 6 |
| 6.4 | Implement "mark medication found" endpoint (POST /searches/:id/found) | `src/routes/searches.ts` | 6.1 | 6 |
| 6.5 | Implement "mark medication not found" endpoint (POST /pharmacies/:id/not-found) | `src/routes/searches.ts` | 6.1 | 6 |
| 6.6 | Implement "join call" endpoint (POST /calls/:id/join) | `src/routes/calls.ts` | 3.8, 4.6 | 6 |
| 6.7 | Implement "end call" endpoint (POST /calls/:id/end) | `src/routes/calls.ts` | 4.2 | 6 |
| 6.8 | Implement "get call queue" endpoint (GET /searches/:id/queue) | `src/routes/calls.ts` | 4.6 | 6 |
| 6.9 | **Implement "acknowledge notification" endpoint (POST /calls/:id/ack)** | `src/routes/calls.ts` | 4.10 | 6 |
| 6.10 | **Implement Twilio Client token endpoint (GET /token)** | `src/routes/token.ts` | 3.1, 2.5 | 6 |
| 6.V | **VERIFY:** Full API flow - create search, get status, acknowledge, join call, mark found | `tests/integration/batch6.test.ts` | 6.10 | 6 |

---

### Batch 7: Frontend Foundation

| # | Task | Files | Deps | Batch |
|---|------|-------|------|-------|
| 7.1 | Initialize React app with Vite and TypeScript | `client/package.json`, `client/vite.config.ts`, `client/tsconfig.json` | 6.V | 7 |
| 7.2 | Set up Tailwind CSS | `client/tailwind.config.js`, `client/src/index.css` | 7.1 | 7 |
| 7.3 | Create API client with axios | `client/src/api/client.ts` | 7.1 | 7 |
| 7.4 | Create auth context and hooks | `client/src/context/AuthContext.tsx`, `client/src/hooks/useAuth.ts` | 7.3 | 7 |
| 7.5 | Create WebSocket connection hook (with auto-reconnect) | `client/src/hooks/useWebSocket.ts` | 7.1 | 7 |
| 7.6 | Build Landing page | `client/src/pages/Home.tsx` | 7.2 | 7 |
| 7.7 | Build Login page | `client/src/pages/Login.tsx` | 7.4 | 7 |
| 7.8 | Build Signup page | `client/src/pages/Signup.tsx` | 7.4 | 7 |
| 7.9 | Create protected route wrapper | `client/src/components/ProtectedRoute.tsx` | 7.4 | 7 |
| 7.10 | Set up React Router with routes | `client/src/App.tsx` | 7.6, 7.7, 7.8, 7.9 | 7 |
| 7.11 | **Add Chrome-only browser check with fallback message** | `client/src/components/BrowserCheck.tsx` | 7.1 | 7 |
| 7.V | **VERIFY:** Frontend builds, Chrome check works, can signup/login | Manual test (Chrome) | 7.11 | 7 |

---

### Batch 8: Frontend Search & Dashboard

| # | Task | Files | Deps | Batch |
|---|------|-------|------|-------|
| 8.1 | Create location input component (with geolocation) | `client/src/components/LocationInput.tsx` | 7.V | 8 |
| 8.2 | Create medication query input component | `client/src/components/MedicationInput.tsx` | 7.2 | 8 |
| 8.3 | Build Search page with inputs | `client/src/pages/Search.tsx` | 8.1, 8.2 | 8 |
| 8.4 | Create pharmacy card component | `client/src/components/PharmacyCard.tsx` | 7.2 | 8 |
| 8.5 | Create pharmacy list component | `client/src/components/PharmacyList.tsx` | 8.4 | 8 |
| 8.6 | Build Dashboard page layout | `client/src/pages/Dashboard.tsx` | 7.9, 7.5 | 8 |
| 8.7 | Create call status indicator component (with IVR_FAILED state) | `client/src/components/CallStatus.tsx` | 7.2 | 8 |
| 8.8 | Create real-time call status updates (WebSocket) | `client/src/hooks/useCallStatus.ts` | 7.5, 8.7 | 8 |
| 8.9 | **Create daily search limit display component** | `client/src/components/SearchLimitBanner.tsx` | 7.3 | 8 |
| 8.V | **VERIFY:** Can search, see results, search limit shown, dashboard shows call statuses | Manual test | 8.9 | 8 |

---

### Batch 9: Frontend Call Interface & Checklist

| # | Task | Files | Deps | Batch |
|---|------|-------|------|-------|
| 9.1 | Create pharmacy checklist component | `client/src/components/PharmacyChecklist.tsx` | 8.V | 9 |
| 9.2 | Create "Did they have it?" prompt modal | `client/src/components/MedicationFoundModal.tsx` | 7.2 | 9 |
| 9.3 | Create call queue display component | `client/src/components/CallQueue.tsx` | 8.7 | 9 |
| 9.4 | Create Twilio Client SDK hook (WebRTC voice) | `client/src/hooks/useTwilioDevice.ts` | 7.1 | 9 |
| 9.5 | Build call interface component (mute, end call, status) | `client/src/components/CallInterface.tsx` | 9.4 | 9 |
| 9.6 | Integrate call interface into Dashboard | `client/src/pages/Dashboard.tsx` | 9.5, 8.6 | 9 |
| 9.7 | Add "Join Call" button to queue items | `client/src/components/CallQueue.tsx` | 9.5, 9.3 | 9 |
| 9.8 | Integrate checklist with "medication found" reset | `client/src/components/PharmacyChecklist.tsx` | 9.1, 9.2 | 9 |
| 9.9 | **Add notification sound/vibration when pharmacist ready** | `client/src/hooks/useNotificationSound.ts` | 7.5 | 9 |
| 9.10 | **Add 60-second countdown timer for patient to respond** | `client/src/components/ResponseTimer.tsx` | 9.3 | 9 |
| 9.11 | **Add IVR failure message component** | `client/src/components/IVRFailureNotice.tsx` | 8.7 | 9 |
| 9.V | **VERIFY:** Full UI flow - search, calls progress, join call, timer works, failure shows | Manual test | 9.11 | 9 |

---

### Batch 10: Deployment & End-to-End Testing

| # | Task | Files | Deps | Batch |
|---|------|-------|------|-------|
| 10.1 | Create Dockerfile for backend | `Dockerfile` | 9.V | 10 |
| 10.2 | Create Dockerfile for frontend | `client/Dockerfile` | 9.V | 10 |
| 10.3 | Set up GitHub Actions CI (lint, test, build) | `.github/workflows/ci.yml` | 10.1, 10.2 | 10 |
| 10.4 | Configure Railway/Render deployment | `railway.json` or `render.yaml` | 10.3 | 10 |
| 10.5 | Deploy to production environment | - | 10.4 | 10 |
| 10.6 | Configure production environment variables (Twilio, OpenAI, Sentry DSN) | - | 10.5 | 10 |
| 10.7 | **Set up cost alert thresholds in production** | - | 10.6 | 10 |
| 10.8 | End-to-end test: Call real CVS pharmacy | - | 10.7 | 10 |
| 10.9 | End-to-end test: Call real Walgreens pharmacy | - | 10.8 | 10 |
| 10.10 | End-to-end test: Full flow with real user (medication found) | - | 10.9 | 10 |
| 10.V | **VERIFY:** MVP Success Criteria - 1 real user successfully finds medication | Manual test | 10.10 | 10 |

<!-- EXECUTION_TASKS_END -->

**Summary: 97 tasks + 11 verification gates across 11 batches (including Batch 0 spike)**

---

## 6. Dependencies

### External Services (Required)

| Service | Purpose | Setup Required |
|---------|---------|----------------|
| **Twilio** | Outbound calls, conferencing, WebRTC client | Account, phone number, Account SID, Auth Token |
| **OpenAI** | Realtime voice AI for IVR navigation | Account, API key with Realtime API access |
| **Google Places API** | Pharmacy search by location | Google Cloud project, API key, billing enabled |
| **PostgreSQL** | Primary database | Local via Docker, production via Railway/Render |
| **Redis** | State machine, pub/sub, caching | Local via Docker, production via Railway/Render |
| **Sentry** | Error tracking and monitoring | Account signup, DSN |

### NPM Packages (Key Dependencies)

| Package | Purpose |
|---------|---------|
| `fastify` | Backend web framework |
| `@prisma/client` | Database ORM |
| `ioredis` | Redis client |
| `socket.io` | WebSocket server |
| `twilio` | Twilio SDK for calls and conferences |
| `openai` | OpenAI SDK |
| `ws` | WebSocket client for OpenAI Realtime |
| `bcrypt` | Password hashing |
| `jsonwebtoken` | JWT auth |
| `axios` | HTTP client (Google Places) |
| `pino` | Structured logging |
| `@sentry/node` | Error tracking |
| `react` | Frontend framework |
| `@twilio/voice-sdk` | Twilio Client for WebRTC voice |
| `socket.io-client` | WebSocket client |
| `@sentry/react` | Frontend error tracking |

### Infrastructure

| Component | Local | Production |
|-----------|-------|------------|
| Backend | Node.js 20+ | Railway/Render |
| Frontend | Vite dev server | Railway/Render (static) |
| Database | Docker PostgreSQL | Railway PostgreSQL |
| Redis | Docker Redis | Railway Redis |
| Monitoring | Local logs | Sentry |
| Domain | localhost | Custom domain (optional) |

---

## 7. Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| **OpenAI Realtime API access denied** | Low | CRITICAL | **Batch 0 spike verifies this first. Contact OpenAI if needed.** |
| **Audio streaming latency issues** | Medium | High | Use efficient codec (PCM16), test with real calls, optimize buffer sizes |
| **IVR navigation fails for some pharmacies** | High | Medium | Start with top 3 chains. Log failures. Add fallback notification to user. |
| **High hold times = high costs** | High | High | Set 15-min timeout. Cost tracking + alerts. Daily spend caps. Per-user limits. |
| **Pharmacy blocks automated calls** | Medium | High | Use legitimate caller ID. AI behaves naturally. Have fallback message. |
| **WebRTC audio quality issues** | Medium | Medium | Chrome-only for MVP. Test Twilio Client SDK thoroughly. |
| **Patient misses notification** | Medium | Low | 60-second timeout. Sound/vibration. WebSocket auto-reconnect. |
| **Google Places API rate limits** | Low | Medium | Cache results. Monitor usage. |
| **Twilio/OpenAI service outage** | Low | High | Sentry alerts. Graceful error handling. User-facing "service unavailable". |
| **Webhook endpoint abuse** | Medium | Medium | **Twilio signature verification required. Rate limiting.** |
| **User abuse (spam calls)** | Medium | High | **Per-user search limit (10/day). Rate limiting. Cost caps.** |
| **HIPAA compliance questions** | Medium | Medium | MVP doesn't store health data. Add disclaimer. Consult legal before scaling. |

### Critical Path Risks (Addressed)
1. ~~**Bland AI's call transfer/bridging capability**~~ → **Pivoted to Twilio + OpenAI DIY**
2. **OpenAI Realtime API availability** → **Batch 0 spike verifies access**
3. **Audio streaming complexity** → **Dedicated audio bridge service**
4. **IVR pattern accuracy** - May need multiple iterations (fallback handler added)
5. ~~**No monitoring**~~ → **Sentry + structured logging added**
6. ~~**No cost controls**~~ → **Cost tracking, alerts, per-user limits added**
7. ~~**Webhook security**~~ → **Twilio signature verification added**

---

## 8. Verification Checklist

### Pre-Launch Checklist

**Infrastructure**
- [ ] PostgreSQL database provisioned and accessible
- [ ] Redis instance provisioned and accessible
- [ ] Backend deployed and responding to health check
- [ ] Frontend deployed and loading correctly
- [ ] Environment variables configured (Twilio SID/token, OpenAI key, JWT secret, Sentry DSN)
- [ ] HTTPS/SSL configured
- [ ] **Sentry receiving error reports**
- [ ] **Cost alerts configured and tested**

**Security**
- [ ] **Twilio webhook signature verification working**
- [ ] **Rate limiting active on all endpoints**
- [ ] **Per-user search limits enforced**
- [ ] Auth endpoints protected against brute force

**Authentication**
- [ ] User can sign up with email/password
- [ ] User can log in and receive JWT
- [ ] Protected routes reject unauthenticated requests
- [ ] JWT expiration and refresh working

**Pharmacy Search**
- [ ] Location input captures user coordinates
- [ ] Google Places API returns pharmacies
- [ ] Results display with name, address, phone
- [ ] Search handles "no results" gracefully
- [ ] **Daily search limit displayed and enforced**

**Call System**
- [ ] Twilio call initiates successfully
- [ ] Audio streams to OpenAI Realtime
- [ ] OpenAI AI navigates IVR for CVS
- [ ] OpenAI AI navigates IVR for Walgreens
- [ ] OpenAI AI navigates IVR for Rite Aid
- [ ] **IVR failure triggers user notification**
- [ ] Human detection triggers notification
- [ ] Voicemail detection triggers notification
- [ ] Call status updates in real-time via WebSocket
- [ ] **Cost per call tracked correctly (Twilio + OpenAI)**

**Conference Bridging**
- [ ] Conference room created successfully
- [ ] AI call added to conference
- [ ] Patient WebRTC connects to conference
- [ ] Both parties can hear each other clearly
- [ ] AI drops out after bridge complete

**Parallel Calling**
- [ ] 3 calls initiate simultaneously
- [ ] Each call's status tracked independently
- [ ] Calls on hold continue when patient joins one
- [ ] **"Thank you for holding" plays before ending connected calls**
- [ ] Connected calls end when patient joins different call

**Patient Join**
- [ ] Twilio Client SDK connection established (Chrome)
- [ ] Audio quality acceptable
- [ ] Patient can hear pharmacist
- [ ] Pharmacist can hear patient
- [ ] Mute/unmute works
- [ ] End call works
- [ ] **60-second response timer works**
- [ ] **Notification sound plays**

**Pharmacy Tracking**
- [ ] Checklist shows all pharmacies in search
- [ ] Status updates as calls progress
- [ ] **IVR failure status shown**
- [ ] "Did they have it?" prompt appears after call
- [ ] "Medication found" resets checklist
- [ ] "Not found" marks pharmacy and continues

**Edge Cases**
- [ ] Handles call timeout (15 min)
- [ ] **Handles patient response timeout (60 sec)**
- [ ] Handles Twilio/OpenAI errors gracefully
- [ ] Handles WebSocket disconnection/reconnection
- [ ] Handles user closing browser mid-call
- [ ] Handles no pharmacies found in area
- [ ] **Non-Chrome browser shows fallback message**

---

## 9. Architectural Notes

### Audio Flow

```
Pharmacy (PSTN)
     │
     ▼
Twilio Call ──Media Streams──▶ PharmacyCaller Server
                                      │
                    ┌─────────────────┼─────────────────┐
                    │                 │                 │
                    ▼                 ▼                 ▼
            Audio Bridge      State Machine     Notifications
                    │                                   │
                    ▼                                   ▼
          OpenAI Realtime ◀─────────────────── Patient UI
              (AI Voice)                        (WebRTC)
```

### Key Architectural Decisions

1. **Twilio Media Streams** - Real-time audio streaming via WebSocket
2. **OpenAI Realtime** - Voice-in/voice-out AI for natural IVR navigation
3. **Twilio Conference** - Bridge multiple participants (AI + patient + pharmacy)
4. **Twilio Client SDK** - WebRTC voice in browser without external dependencies
5. **PCM16 Audio Format** - Compatible with both Twilio and OpenAI

### State Machine

```
CREATED → DIALING → IVR ┬→ HOLD → HUMAN_DETECTED → BRIDGING → CONNECTED → ENDING → ENDED
                        │            │
                        │            └→ VOICEMAIL → CONNECTED → ENDING → ENDED
                        │
                        └→ IVR_FAILED → ENDED
```

---

## Next Steps

**IMPORTANT:** Start with Batch 0 spike to verify Twilio + OpenAI Realtime capabilities.

```bash
cd spike
npm install
cp .env.example .env
# Add your Twilio and OpenAI credentials
npm run test-twilio
npm run test-openai
npm run test-conference
```

When all spike tests pass, proceed to Batch 1:

```
claudikins-kernel:execute .claude/plans/plan-2026-01-18-1201.md
```

---

*Plan generated by claudikins-kernel:outline*
*Architectural pivot: Bland AI → Twilio + OpenAI Realtime (2026-01-18)*
